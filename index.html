<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="dashboard-grid">
        <div class="dashboard-panel broadcast">
            <h2>Broadcast Message</h2>
            <form id="broadcast-form">
                <div class="form-group">
                    <label for="broadcastChatId">Chat ID</label>
                    <input type="text" id="broadcastChatId" name="chatId" required placeholder="Click 'To Broadcast' in Live Feed">
                </div>
                <div class="form-group">
                    <label for="broadcastMessage">Message</label>
                    <textarea id="broadcastMessage" name="message" required placeholder="Type your announcement here..."></textarea>
                </div>
                <button type="submit">Send Broadcast</button>
                <div id="broadcast-status" class="status-message"></div>
            </form>
        </div>
        
        <div class="dashboard-panel reply">
            <h2>Direct Reply</h2>
            <form id="reply-form">
                <div class="form-group">
                    <label for="replyChatId">Chat ID</label>
                    <input type="text" id="replyChatId" name="chatId" required placeholder="Click 'To Reply' in Live Feed">
                </div>
                <div class="form-group">
                    <label for="replyMessageId">Message ID</label>
                    <input type="text" id="replyMessageId" name="messageId" required placeholder="Click 'To Reply' in Live Feed">
                </div>
                <div class="form-group">
                    <label for="replyMessage">Your Reply</label>
                    <textarea id="replyMessage" name="message" required placeholder="Type your custom reply here..."></textarea>
                </div>
                <button type="submit">Send Reply</button>
                <div id="reply-status" class="status-message"></div>
            </form>
        </div>

        <div class="dashboard-panel activity">
            <h2>
                <span>Live Bot Activity</span>
                <a href="/manager">Manage Responses &rarr;</a>
            </h2>
            <div id="feed-container" class="scrollable-content"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            async function handleFormSubmit(form, endpoint, statusElement) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    statusElement.textContent = 'Sending...';
                    statusElement.className = 'status-message';
                    const data = Object.fromEntries(new FormData(form).entries());

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (response.ok) {
                        statusElement.className = 'status-message success';
                        statusElement.textContent = result.message || 'Success!';
                        form.reset();
                    } else {
                        statusElement.className = 'status-message error';
                        statusElement.textContent = 'Error: ' + result.error;
                    }
                    setTimeout(() => statusElement.textContent = '', 3000);
                });
            }

            handleFormSubmit(document.getElementById('broadcast-form'), '/api/broadcast', document.getElementById('broadcast-status'));
            handleFormSubmit(document.getElementById('reply-form'), '/api/reply', document.getElementById('reply-status'));

            const feedContainer = document.getElementById('feed-container');
            const eventSource = new EventSource('/events');

            eventSource.onmessage = (event) => {
                const log = JSON.parse(event.data);
                const logElement = document.createElement('div');
                const time = new Date(log.timestamp).toLocaleTimeString();
                
                let logBodyHtml = '';
                const userSpan = `<span class="log-user">${log.user}</span>`;
                const triggerSpan = `<span class="log-trigger">${log.trigger}</span>`;
                let logClass = 'log-entry';
                let typeClass = 'log-type';
                let icon = 'üí¨';

                // ############ THE FIX IS HERE ############
                switch (log.eventType) {
                    case 'Triggered Response':
                        icon = '‚úÖ';
                        logBodyHtml = `${userSpan} triggered response with ${triggerSpan}`;
                        break;
                    case 'New User':
                        icon = 'üöÄ';
                        logClass = 'log-entry log-entry--system';
                        typeClass = 'log-type log-type--system';
                        logBodyHtml = `${userSpan} started the bot.`;
                        break;
                    case 'ADMIN_ACTION':
                        icon = '‚öôÔ∏è';
                        logClass = 'log-entry log-entry--admin';
                        typeClass = 'log-type log-type--admin';
                        logBodyHtml = `${userSpan} performed action: ${triggerSpan}`;
                        break;
                    case 'DM Message':
                        icon = '‚úâÔ∏è';
                        logBodyHtml = `${userSpan} sent a DM: ${triggerSpan}`;
                        break;
                    case 'Reply to Bot':
                        icon = '‚Ü™Ô∏è';
                        logBodyHtml = `${userSpan} replied to the bot: ${triggerSpan}`;
                        break;
                    default:
                        logBodyHtml = `${userSpan} sent message: ${triggerSpan}`;
                        break;
                }
                logElement.className = logClass;

                // We show action buttons for DMs and Replies now
                let actionsHtml = `
                    <div class="log-actions">
                        <button class="send-to-reply-btn">To Reply</button>
                        <button class="send-to-broadcast-btn">To Broadcast</button>
                    </div>`;
                if (['ADMIN_ACTION', 'New User'].includes(log.eventType)) {
                    actionsHtml = ''; 
                }
                
                // For DM messages, we only want a reply button, not broadcast
                if (log.eventType === 'DM Message') {
                    actionsHtml = `
                    <div class="log-actions">
                        <button class="send-to-reply-btn">To Reply</button>
                    </div>`;
                }


                logElement.innerHTML = `
                    <div class="log-header">
                        <span class="${typeClass}"><span class="icon">${icon}</span> ${log.eventType}</span>
                        <span class="log-time">${time}</span>
                    </div>
                    <div class="log-body">${logBodyHtml}</div>
                    <div class="log-body">
                        <span class="log-chat-info">In: ${log.chatInfo}</span>
                        ${log.chatId ? `<span class="log-id" title="Chat ID">#${log.chatId}</span>` : ''}
                        ${log.messageId ? `<span class="log-id" title="Message ID">Msg: ${log.messageId}</span>` : ''}
                    </div>
                    ${actionsHtml}`;
                
                // Re-add event listeners since we re-created the buttons
                if (logElement.querySelector('.send-to-reply-btn')) {
                    logElement.querySelector('.send-to-reply-btn').addEventListener('click', () => {
                        document.getElementById('replyChatId').value = log.chatId;
                        document.getElementById('replyMessageId').value = log.messageId;
                        document.getElementById('replyMessage').focus();
                    });
                }
                if (logElement.querySelector('.send-to-broadcast-btn')) {
                     logElement.querySelector('.send-to-broadcast-btn').addEventListener('click', () => {
                        document.getElementById('broadcastChatId').value = log.chatId;
                        document.getElementById('broadcastMessage').focus();
                    });
                }
                
                feedContainer.prepend(logElement);
            };
            eventSource.onerror = () => { logger.error('EventSource failed.'); };
        });
    </script>
</body>
</html>